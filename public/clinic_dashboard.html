<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Dashboard | Clinify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Styles omitted for brevity */
        body { margin: 0; font-family: sans-serif; display: flex; }
        #sidebar { width: 200px; background-color: #0d9488; color: white; padding: 20px; height: 100vh; }
        #main-content { flex-grow: 1; padding: 30px; }
        .sidebar-link { display: block; padding: 10px; margin-bottom: 10px; border-radius: 5px; text-decoration: none; color: white; transition: background-color 0.2s; }
        .sidebar-link:hover { background-color: #0f766e; }
        .patient-form label { display: block; margin-top: 10px; font-weight: bold; }
        .patient-form input, .patient-form select, .patient-form textarea { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .patient-form button[type="submit"] { background-color: #059669; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 15px; }
        .error-message { color: red; border: 1px solid red; padding: 10px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2 class="text-xl font-bold mb-8">Clinify Clinic</h2>
        <nav>
            <a href="/clinic_dashboard.html" class="sidebar-link">Dashboard</a>
            
            <a href="/clinic_dashboard.html?page=patients" id="patients-link" class="sidebar-link">Patients</a>
            
            <a href="#" id="sign-out-link" class="sidebar-link" style="margin-top: 30px; background-color: #dc2626;">Sign Out</a>
        </nav>
        <div id="user-info" class="mt-auto text-sm"></div>
    </div>

    <div id="main-content">
        <header class="mb-6">
            <h1 id="page-title" class="text-2xl font-bold text-gray-800">Clinic Dashboard</h1>
        </header>
        <div id="root">
            Loading Application...
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>
    
    <script>
        // ðŸ”¥ Firebase project configuration (Same as index.html)
        const firebaseConfig = {
          apiKey: "AIzaSyACQiXRP26hS6NqbvtON-XPyYD2etnKZWE",
          authDomain: "clinify-saas-prod.firebaseapp.com",
          projectId: "clinify-saas-prod",
          storageBucket: "clinify-saas-prod.firebasestorage.app",
          messagingSenderId: "1026039308880",
          appId: "1:1026039308880:web:eeae6c49862da2b526e755"
        };
        firebase.initializeApp(firebaseConfig);
    </script>

    <script type="text/babel" src="../src/services/firebaseService.js"></script>
    <script type="text/babel" src="../src/components/patient/NewPatientForm.js"></script>
    <script type="text/babel" src="../src/pages/PatientsPage.js"></script>

    <script type="text/babel">
        // MAIN APPLICATION ROUTER AND RENDERER
        
        const auth = firebase.auth();
        const root = ReactDOM.createRoot(document.getElementById('root'));

        // Sign Out Logic
        document.getElementById('sign-out-link').addEventListener('click', (e) => {
            e.preventDefault();
            auth.signOut().then(() => {
                window.location.href = '/index.html'; 
            });
        });

        // Function to handle Google Sign-In
        const handleGoogleSignIn = () => {
             const provider = new firebase.auth.GoogleAuthProvider();
             document.getElementById('auth-status-dashboard').textContent = 'Signing in...';
             
             auth.signInWithPopup(provider)
                .then(() => {
                    // Session is stable on this page, the onAuthStateChanged listener will re-render
                })
                .catch((error) => {
                    console.error("Authentication Error:", error);
                    document.getElementById('auth-status-dashboard').textContent = `Login failed: ${error.message}`;
                });
        };

        // 1. Authentication Check
        auth.onAuthStateChanged(user => {
            if (!user) {
                 // ðŸ’¥ FIX: Render a login screen on the dashboard page instead of redirecting ðŸ’¥
                 document.getElementById('user-info').textContent = 'Session lost.';
                 document.getElementById('sidebar').style.display = 'none'; // Hide sidebar links
                 document.getElementById('page-title').textContent = 'Login Required';

                 root.render(
                    <div className="flex flex-col items-center justify-center h-full pt-10">
                        <p className="mb-4 text-gray-700">Please sign in to access the Clinify Clinic Dashboard.</p>
                        <button 
                            id="google-sign-in-dashboard"
                            onClick={handleGoogleSignIn}
                            className="w-full flex items-center justify-center max-w-sm px-4 py-3 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-150 ease-in-out"
                        >
                            <svg className="w-5 h-5 mr-3" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path fill="#4285F4" d="M44.5 20H24v8.5h11.8C35.5 31.8 34.3 35 32 37.3l7.9 6.1C44.6 39 48 34 48 27.5c0-1.8-.3-3.6-.8-5.3z"/>
                                <path fill="#34A853" d="M24 48c6.6 0 12.1-2.2 16.1-6.1l-7.9-6.1c-2.3 1.5-5.2 2.4-8.2 2.4-6.3 0-11.7-4.2-13.6-9.9l-8 6.2C7.8 44.5 15.4 48 24 48z"/>
                                <path fill="#FBBC05" d="M10.4 28.5c-.5-1.5-.8-3-.8-4.5s.3-3 .8-4.5L2.4 13C.8 17.5 0 22.5 0 27.5s.8 10 2.4 14.5L10.4 28.5z"/>
                                <path fill="#EA4335" d="M24 9.5c3.2 0 6.1 1.1 8.4 3.3l6.5-6.5C36.1 2.2 30.6 0 24 0 15.4 0 7.8 3.5 2.4 9.5l8 6.2C12.3 13.7 17.7 9.5 24 9.5z"/>
                            </svg>
                            Sign in with Google
                        </button>
                        <div id="auth-status-dashboard" className="text-sm text-center text-red-500 min-h-[1.25rem] mt-4"></div>
                    </div>
                 );
                 return;
            }
            
            // 2. LOGGED IN USER STATE
            document.getElementById('sidebar').style.display = 'block'; // Show sidebar
            document.getElementById('user-info').textContent = `Logged in as: ${user.email}`;

            // 3. Simple Client-Side Router
            const renderPage = () => {
                const urlParams = new URLSearchParams(window.location.search);
                const page = urlParams.get('page');
                const pageTitle = document.getElementById('page-title');

                if (page === 'patients') {
                    // Render the Patients Page
                    pageTitle.textContent = "Patient Management";
                    // IMPORTANT: The key to stability is that PatientsPage must run without errors
                    // if it errors out (e.g., in firebaseService.js), it might drop the session.
                    root.render(<PatientsPage />); 
                } else {
                    // Default Dashboard View
                    pageTitle.textContent = "Clinic Overview";
                    root.render(
                        <div>
                            <p>Welcome to your Clinify Dashboard.</p>
                            <p>Use the **Patients** link on the left to start adding records.</p>
                            <p>Clinic ID: {user.uid}</p>
                        </div>
                    );
                }
            };
            
            window.addEventListener('popstate', renderPage);
            renderPage();
        });

    </script>
</body>
</html>